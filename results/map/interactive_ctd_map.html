<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carte interactive — points CTD avec filtre date (DEBUG)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster-src.js"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- noUiSlider -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    #top { padding:10px; display:flex; gap:12px; align-items:center; background:#f7f7f7; }
    #map { height: calc(100vh - 160px); background: #eef; }
    #controls { padding:10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .info { font-size:0.9rem; color:#333; }
    #progress { width:300px; }
    #slider { width:420px; margin-left:8px; }
    #stats { margin-left:12px; font-size:0.9rem; }
    .small { font-size:0.85rem; color:#666 }
    #debug { padding:8px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; margin:8px; display:none }
    #errorBox { padding:12px; background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; margin:8px; display:none }
  </style>
</head>
<body>
  <div id="top">
    <div>
      <label class="info"><strong>Fichier CSV :</strong></label>
      <input id="fileInput" type="file" accept=".csv,text/csv" />
      <span class="small">(1ère ligne = noms, 2ème = unités)</span>
    </div>
    <div id="controls">
      <div>
        <label class="info">Plage de dates :</label>
        <div id="slider"></div>
      </div>
      <div id="stats">Points chargés: <span id="loaded">0</span> — Points affichés: <span id="shown">0</span></div>
      <div id="progress" class="small"></div>
      <button id="resetView">Reset vue</button>
    </div>
  </div>

  <div id="debug">Debug: la page a chargé les scripts principaux.</div>
  <div id="errorBox"></div>

  <div id="map"></div>

  <script>
    // --- Helper to show JS errors visibly on page ---
    const errorBox = document.getElementById('errorBox');
    function showError(msg) {
      errorBox.style.display = 'block';
      errorBox.innerText = msg;
      console.error(msg);
    }

    window.addEventListener('error', function (e) {
      showError('Erreur JS: ' + (e.message || e));
    });
    window.addEventListener('unhandledrejection', function (e) {
      showError('Promise rejection: ' + (e.reason && e.reason.message ? e.reason.message : e.reason));
    });

    // Quick check that external libraries loaded
    function checkLibs() {
      const debug = document.getElementById('debug');
      let msgs = [];
      if (typeof L === 'undefined') msgs.push('Leaflet non chargé (L absent)');
      if (typeof Papa === 'undefined') msgs.push('PapaParse non chargé (Papa absent)');
      if (typeof noUiSlider === 'undefined') msgs.push('noUiSlider non chargé (noUiSlider absent)');
      if (msgs.length === 0) {
        debug.style.display = 'block';
        debug.innerText = 'Debug: bibliothèques chargées correctement.';
        return true;
      } else {
        showError('Bibliothèques manquantes:' + msgs.join(''));
        return false;
      }
    }

    // === Configuration & variables ===
    const MAX_KEEP_POINTS = 300000;
    let headers = null, units = null, colIndex = {};
    let points = [], minTime = null, maxTime = null;

    // --- verify libs ---
    if (!checkLibs()) {
      // stop if libs missing
      throw new Error('Bibliothèques nécessaires manquantes — voir message ci-dessus.');
    }

    // Leaflet map + cluster layer
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '© OpenStreetMap' }).addTo(map);
    const markersLayer = L.markerClusterGroup({ chunkedLoading: true, showCoverageOnHover: false });
    map.addLayer(markersLayer);

    // slider placeholder
    const slider = document.getElementById('slider');
    let sliderControl = null;

    // DOM refs
    const fileInput = document.getElementById('fileInput');
    const loadedSpan = document.getElementById('loaded');
    const shownSpan = document.getElementById('shown');
    const progressDiv = document.getElementById('progress');
    const resetBtn = document.getElementById('resetView');

    resetBtn.onclick = () => map.setView([0,0],2);

    function parseDateFlexible(s) {
      if (!s) return null;
      const d = new Date(s);
      if (!isNaN(d)) return d;
      const s2 = s.replace(' ', 'T');
      const d2 = new Date(s2);
      if (!isNaN(d2)) return d2;
      const year = parseInt(s);
      if (!isNaN(year) && year > 1800 && year < 3000) return new Date(Date.UTC(year,0,1));
      return null;
    }

    // Escape HTML to avoid injection into popups
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function updateStats() { loadedSpan.textContent = points.length.toLocaleString(); shownSpan.textContent = markersLayer.getLayers().length.toLocaleString(); }

    // Add point to map — now includes station name in popup
    function addPointToMap(p) {
      const marker = L.circleMarker([p.lat, p.lon], { radius: 4 });
      const stationEsc = escapeHtml(p.station || '');
      const timeStr = p.t ? p.t.toISOString() : '';
      const popupHtml = `
        ${stationEsc ? `<strong>${stationEsc}</strong><br/>` : ''}
        <strong>${timeStr}</strong><br/>
        lat: ${p.lat}<br/>lon: ${p.lon}
      `;
      marker.bindPopup(popupHtml);
      markersLayer.addLayer(marker);
    }

    function refreshMapForRange(range) {
      if (!range || points.length === 0) return;
      const [tMin, tMax] = range;
      markersLayer.clearLayers();
      for (let i=0;i<points.length;i++){
        const p = points[i];
        const ms = p.t.getTime();
        if (ms >= tMin && ms <= tMax) addPointToMap(p);
      }
      updateStats();
    }

    function setupSlider(minDate, maxDate) {
      if (sliderControl) sliderControl.destroy();
      sliderControl = noUiSlider.create(slider, {
        start: [minDate.getTime(), maxDate.getTime()],
        connect: true,
        range: { min: minDate.getTime(), max: maxDate.getTime() },
        tooltips: [true, true],
        format: {
          to: function(value) { const d = new Date(+value); return d.getUTCFullYear(); },
          from: function(value) { return Number(value); }
        }
      });
      sliderControl.on('update', function(values, handle, unencoded) {
        const min = Math.floor(unencoded[0]);
        const max = Math.ceil(unencoded[1]);
        refreshMapForRange([min, max]);
      });
      refreshMapForRange([minDate.getTime(), maxDate.getTime()]);
    }

    fileInput.addEventListener('change', (ev)=>{
      const file = ev.target.files && ev.target.files[0]; if (!file) return;
      headers = null; units = null; colIndex = {}; points = []; minTime = null; maxTime = null; markersLayer.clearLayers(); updateStats(); progressDiv.textContent = 'Parsing...';

      let rowCount = 0;
      Papa.parse(file, {
        delimiter: ',', newline: '',
        step: function(results, parser) {
          const row = results.data; rowCount += 1; if (row.length === 1 && row[0] === '') return;
          if (rowCount === 1) {
            headers = row.map(c => (c||'').trim());
            // normalize header names to lowercase keys for robustness
            headers.forEach((h,i)=>{ colIndex[(h||'').toLowerCase()]=i; });
            return;
          }
          if (rowCount === 2) { units = row.map(c => (c||'').trim()); return; }

          const timeIdx = colIndex['time'];
          const latIdx = colIndex['latitude'];
          const lonIdx = colIndex['longitude'];
          const stationIdx = colIndex['station']; // now supported

          if (timeIdx === undefined || latIdx === undefined || lonIdx === undefined) {
            parser.abort();
            showError('Colonnes obligatoires manquantes : time, latitude, longitude (vérifie la 1ère ligne).');
            return;
          }

          const timeStr = row[timeIdx];
          const latStr = row[latIdx];
          const lonStr = row[lonIdx];
          const stationStr = stationIdx !== undefined ? (row[stationIdx] || '').trim() : '';

          const t = parseDateFlexible(timeStr);
          const lat = parseFloat(latStr);
          const lon = parseFloat(lonStr);
          if (t && !isNaN(lat) && !isNaN(lon)) {
            points.push({ t, lat, lon, station: stationStr, raw: row });
            if (!minTime || t < minTime) minTime = t;
            if (!maxTime || t > maxTime) maxTime = t;
          }

          if (points.length > MAX_KEEP_POINTS) {
            points = points.filter((_, idx) => idx % 2 === 0);
            progressDiv.textContent = `Décimation automatique — points gardés: ${points.length.toLocaleString()}`;
          }
          if (rowCount % 50000 === 0) {
            progressDiv.textContent = `Rows lues: ${rowCount.toLocaleString()} — points: ${points.length.toLocaleString()}`;
          }
        },
        complete: function() {
          progressDiv.textContent = `Parsing terminé — rows: ${rowCount.toLocaleString()} — points valides: ${points.length.toLocaleString()}`;
          if (!minTime || !maxTime) { showError('Aucune date valide trouvée dans la colonne "time".'); return; }
          setupSlider(minTime, maxTime);
          const latlngs = points.map(p => [p.lat, p.lon]);
          const bounds = L.latLngBounds(latlngs);
          if (bounds.isValid()) map.fitBounds(bounds);

          // batch add for responsiveness
          const batchSize = 20000; let i = 0;
          function addBatch() {
            const end = Math.min(points.length, i + batchSize);
            for (; i < end; i++) addPointToMap(points[i]);
            updateStats();
            if (i < points.length) setTimeout(addBatch, 50);
            else progressDiv.textContent += ' — rendu complet.';
          }
          addBatch();
        },
        error: function(err) { showError('Erreur lors du parsing: ' + err.message); },
        skipEmptyLines: true, worker: false, encoding: 'utf-8', dynamicTyping: false
      });
    });

    // final: log ready
    console.log('Interactive CTD map script chargé.');
  </script>

  <!-- Note: la colonne dans le CSV doit s'appeler "station" (insensible à la casse) -->
</body>
</html>
